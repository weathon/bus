<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css" />
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <title>CoMo Bus Timer</title>
</head>

<body>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAgMo2y743lim1h4IGq3BvlUl8Ar0fl1hQ&callback=initMap&v=weekly"
        async></script>
    <ion-app id="app">
        <ion-header translucent>
            <ion-toolbar>
                <ion-title>CoMo Bus Timer</ion-title>
            </ion-toolbar>
        </ion-header>

        <ion-content fullscreen>
            <ion-list>
                <ion-list-header> Select A Route </ion-list-header>

                <ion-item v-for="item in list" :key="list.name" @click="setAlert(item.id)">
                    <ion-avatar slot="start">
                        <ion-icon name="bus" size="large" v-bind:style="{width: '100%', color: '#'+item.color}">
                        </ion-icon>
                    </ion-avatar>
                    <ion-label>
                        <h2>{{ item.name }}</h2>
                    </ion-label>
                </ion-item>
            </ion-list>
        </ion-content>
    </ion-app>
</body>
<ul>
</ul>


<ion-modal id="card-modal" backdropDismiss=false>

    <ion-content>
        <ion-header translucent>
            <ion-toolbar>
                <ion-title>Map</ion-title>
                <ion-button onclick="location.reload()">Exit</ion-button>

            </ion-toolbar>
        </ion-header>
        <br />
        <ion-list-header>Select A Bus Stop That You Will Get On The Bus</ion-list-header>
        <!-- <p>Now this app won't show the buses' location, sorry.</p> -->
        <div id="GMap" style="height: 60%;width:95%;left:2.5%"></div>
        <p id="selected"></p>
        <ion-list-header>How many miles before the bus approaches the stop do you want to get a notification.
        </ion-list-header>
        <ion-item>
            <ion-input type="number" placeholder="Enter a number"></ion-input>
        </ion-item>
        <ion-button expand="block" onclick="startTracking()">Set The Notification!</ion-button>
    </ion-content>
</ion-modal>


<script>
    document.getElementById("card-modal").backdropDismiss = false;
    document.getElementById("card-modal").showBackdrop = 1;
    var selectedStop = -1;
    var selectedRoute = -1;
    function checkForBus(possibleBusIDs, milage, selectedStop) {
        console.log([possibleBusIDs, milage, selectedStop])
    }
    
    function startTracking() {
        if (selectedStop == -1) {
            alert("Please select a bus stop");
            return;
        }
        if (selectedRoute == -1) {
            alert("Please select a route");
            return;
        }
        milage = document.getElementsByTagName("ion-input")[0].value;
        console.log(milage); //why is this not working? huangbierenchaojlphcjaxlxpiui xueyabierenwnaifangconsole you -url
        if (milage == "") {
            alert("Please enter a number");
            return;
        }
        if (Number(milage) == NaN) {
            alert("Please enter a number");
            return;
        }
        //fetch from http://coder.weathon.top:8888/buses
        fetch('http://coder.weathon.top:8888/buses')
            .then(function (response) {
                return response.json();
            })
            .then(function (buses) {
                possibleBusIDs = []; //zhege huigengxing?yachihong 

                for (var i = 0; i < buses.length; i++) {
                    if (buses[i].route == selectedRoute) {
                        possibleBusIDs.push(buses[i].id);
                    }
                    // setInterval(checkForBus, possibleBusIDs, milage, selectedStop, 1000);

                }
                if (possibleBusIDs.length == 0) {
                    alert("No buses found for this route");
                    return;
                }//zhegewodoumeiyouxiangdao 
                console.log(possibleBusIDs)
                setInterval(checkForBus, possibleBusIDs, milage, selectedStop, 1000);

            });
    }
    function initMap() {
        const myLatLng = { lat: 38.9517, lng: -92.3341 };
        map = new google.maps.Map(document.getElementById("GMap"), {
            zoom: 12,
            center: myLatLng,
        });
    }

    alert("This app is made by a Mizzou student, who is NOT connected with the University of Missouri, Tiger Line, GoCoMo, or the City of Columbia.\
     This app only represents my position. This app is still in testing; it might cause a false alert or miss alert. If you have any advice, please\
      e-mail wg25r@umsystem.edu. The data of the app is fetched from Doublemap via my own server. ")
    new Vue({
        el: '#app',
        data: {
            list: []
        },
        created: function () {
            var self = this;
            fetch('http://coder.weathon.top:8888/routes')
                .then(function (response) {
                    return response.json();
                })
                .then(function (json) {
                    self.list = json;
                });
        },
        methods: {

            setAlert: function (routeID) {
                selectedRoute = routeID;
                document.getElementById("card-modal").present()
                fetch('http://coder.weathon.top:8888/routes')
                    .then(function (response) {
                        console.log(routeID)
                        return response.json();
                    })
                    .then(function (json) {
                        console.log(json)
                        for (var i = 0; i < json.length; i++) {
                            console.log(json[i].id)
                            if (json[i].id == routeID) {
                                var route = json[i]
                                break;
                            }
                        }

                        const triangleCoords = [
                        ];
                        for (var i = 0; i < route.path.length / 2; i++) {
                            triangleCoords.push({ lat: route.path[i * 2], lng: route.path[i * 2 + 1] });

                        }
                        var stops = {};
                        fetch('http://coder.weathon.top:8888/stops')
                            .then(function (response) {
                                return response.json();
                            })
                            .then(function (json) {
                                var stops = json;
                                console.log(stops)
                                markers = [] //not {}

                                for (var i = 0; i < route.stops.length; i++) {
                                    for (var j = 0; j < stops.length; j++) {
                                        // console.log(j.id) stupid copolit 
                                        if (stops[j].id == route.stops[i]) {
                                            var stop = stops[j]
                                            console.log(stop.id)
                                            markers.push(new google.maps.Marker({
                                                position: { lat: stop.lat, lng: stop.lon },
                                                map,
                                                icon: "dot.png",
                                                // title: stop.name,
                                                // stopID: stop.id,
                                            }));
                                            addEvent(stop, markers[length - 1]);
                                        }
                                    }
                                }
                            })

                        console.log(triangleCoords)
                        bermudaTriangle = new google.maps.Polyline({
                            path: triangleCoords,
                            strokeColor: "#" + route.color,
                            strokeOpacity: 0.8,
                            strokeWeight: 4,
                        });
                        bermudaTriangle.setMap(map);
                    });

            }
        }
    });
    function addEvent(stop, marker) {
        console.log(stop);
        google.maps.event.addListener(markers[markers.length - 1], "click", () => {
            console.log(stop.name)
            document.getElementById("selected").innerHTML = "You have selected " + stop.name;
            selectedStop = stop.id
        });
    }
</script>

</body>

</html>